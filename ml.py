# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1HIaWB-PM7rTZrVkSBmhkw1E-Faed6akM
"""
import streamlit as st
import pandas as pd
import numpy as np
import csv
import matplotlib.pyplot as plt

# Scikit-learn (Modelos de Regresi√≥n)
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.tree import DecisionTreeRegressor
from sklearn.ensemble import RandomForestRegressor
from sklearn.svm import SVR
from sklearn.metrics import r2_score, mean_absolute_error, mean_squared_error


# -----------------------------------------------------------
#  FUNCI√ìN PARA CARGAR CSV Y DETECTAR DELIMITADOR AUTOM√ÅTICO
# -----------------------------------------------------------
def cargar_csv(uploaded_file):
    contenido = uploaded_file.read().decode('latin-1', errors='ignore')
    uploaded_file.seek(0)

    try:
        dialect = csv.Sniffer().sniff(contenido.splitlines()[0])
        sep = dialect.delimiter
    except:
        sep = ','  # Si no detecta, usamos coma por defecto

    df = pd.read_csv(uploaded_file, sep=sep, engine="python")
    df.columns = df.columns.str.strip()

    # Convertir todas las columnas posibles a num√©ricas
    for col in df.columns:
        df[col] = (
            df[col]
            .astype(str)
            .str.replace(",", "", regex=False)
            .str.strip()
        )
        df[col] = pd.to_numeric(df[col], errors='ignore')

    return df


# -----------------------------------------------------------
# M√âTRICAS
# -----------------------------------------------------------
def calculate_metrics(y_true, y_pred, subset_name):
    return {
        'Conjunto': subset_name,
        'R2': r2_score(y_true, y_pred),
        'MAE': mean_absolute_error(y_true, y_pred),
        'RMSE': np.sqrt(mean_squared_error(y_true, y_pred)),
        'Bias': np.mean(y_pred - y_true)
    }


# -----------------------------------------------------------
# INTERFAZ STREAMLIT
# -----------------------------------------------------------

st.set_page_config(page_title="Aplicaci√≥n Interactiva de Modelos de Regresi√≥n Hidrol√≥gica", layout="wide")

st.title("üåä Aplicaci√≥n Interactiva de Modelos de Regresi√≥n Hidrol√≥gica")
st.markdown("---")

with st.sidebar:
    st.header("1. Cargar Datos CSV")
    uploaded_file = st.file_uploader("Seleccione archivo CSV", type=['csv'])

df = None
if uploaded_file:
    df = cargar_csv(uploaded_file)

    if df.shape[0] == 0:
        st.error("‚ö† El archivo se carg√≥ pero **no contiene filas v√°lidas**. Revisa el delimitador o el formato.")
        st.stop()
    else:
        st.success(f"‚úÖ Archivo cargado correctamente: {df.shape[0]} filas, {df.shape[1]} columnas.")
        st.dataframe(df.head())


if df is None:
    st.info("Por favor cargue un archivo CSV para continuar.")
    st.stop()


# Selecci√≥n de variables
with st.sidebar:
    st.header("2. Selecci√≥n de Variables")
    column_names = df.columns.t_
